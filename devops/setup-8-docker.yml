- hosts: server
  become: true
  tasks:
    - name: Check what is installed
      package_facts:
        manager: "auto"
    - name: Install curl if not already installed
      ansible.builtin.apt:
        pkg:
          - curl
      when: "ansible_facts.packages['curl'] is undefined"
    - name: Install docker
      ansible.builtin.shell: |
        curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
        sudo sh /tmp/get-docker.sh
      when: "ansible_facts.packages['docker-ce'] is undefined"
- hosts: server
  tasks:
    - name: Does repository exist on server
      stat:
        path: ~/clothingloop.org
      register: is_repo
    - name: Git clone repository
      command: git clone --depth 10 https://github.com/the-clothing-loop/website.git clothingloop.org
      when: not is_repo.stat.exists
    - name: Git pull repository
      shell: |
        cd ~/clothingloop.org
        git pull origin main
    - name: Copy .env file from repository
      copy:
        src: "{{ playbook_dir }}/../docker/vps1/.env"
        dest: "/home/admin/clothingloop.org/docker/vps1/.env"
        owner: admin
        group: admin
        mode: "0775"
